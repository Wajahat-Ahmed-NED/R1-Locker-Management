package LockerManagement;

import javax.swing.JFrame;
import java.awt.Color;
import java.awt.Component;
import java.awt.Dimension;

import javax.swing.JTable;
import javax.swing.JLabel;
import java.awt.Font;
import javax.swing.JButton;
import javax.swing.JList;
import javax.swing.JComboBox;
import javax.swing.DefaultComboBoxModel;
import javax.swing.JOptionPane;
import javax.swing.JScrollPane;
import javax.swing.JTextPane;
import javax.swing.JTextField;
import javax.swing.table.DefaultTableModel;

import java.awt.event.ActionListener;
import java.awt.event.ActionEvent;
import java.awt.Point;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.util.ArrayList;
import java.util.HashMap;

import javax.swing.JPanel;
import java.awt.event.FocusAdapter;
import java.awt.event.FocusEvent;

public class lockerIssuance extends JFrame {
	private JTable smallLockerTable;
	private JTextField accountNumberText;
	String [] columnNames={"Locker Available", "Lockers Size"};
	Object[][] data= new Object[3][2];
	boolean auth=true;
//	ArrayList<Integer> availableLockers= new ArrayList<>();
	HashMap<String,Integer> availableLockers;
	
	public lockerIssuance()
	{
		JPanel panel= new JPanel();
		panel.setBounds(24,23,403,262);
		getContentPane().add(panel);
		panel.setLayout(null);
		smallLockerTable=new JTable(data,columnNames);
		smallLockerTable.setBounds(10,25,674,174);
		getContentPane().add(smallLockerTable);
		JScrollPane scroll=new JScrollPane(smallLockerTable);
		scroll.setBounds(0,0,403,262);
		panel.add(scroll);
		try {
			Class.forName("COM.ibm.db2.jdbc.app.DB2Driver");
			java.sql.Connection connection = null;
			java.sql.Statement  lcl_stmt =null;
			connection = java.sql.DriverManager.getConnection("jdbc:db2:WA27389", "db2admin", "admin123/?");
						
			String query="select count(*) as Available, lockersizeid from locker where lockernum not in(select lockernum from lockerassigned_tr union select lockernum from lockerassigned_tl order by lockernum) group by lockersizeid;";
			PreparedStatement statement = connection.prepareStatement(query);
			
			ResultSet result = statement.executeQuery();
			
			
			
			ArrayList<Object[]> rows= new ArrayList<>();
			while(result.next()) {
				Object[] row= new Object[2];
				for ( int i=0;i<2;i++){
					
					row[i]=result.getString(i+1);
				}
//				availableLockers.add(Integer.parseInt((String) row[0]));
//				
				if(row[1].equals("1")){
					row[1]="Small";
//					availableLockers.put("Small",Integer.parseInt((String) row[0]));
				}
				else if (row[1].equals("2")){
					row[1]="Medium";
//					availableLockers.put("Medium",Integer.parseInt((String) row[0]));
				}
				else if (row[1].equals("3")){
					row[1]="Large";
//					availableLockers.put("Large",Integer.parseInt((String) row[0]));
				}
				rows.add(row);
				availableLockers.put( "small",Integer.parseInt((String) row[0]));
			}
			
			
			for (int i=0; i<rows.size();i++){
				data[i]=rows.get(i);
			}
		} catch (Exception e) {
			System.out.println(e.getMessage());
			System.out.println("DB Connection fail");
		}
		
		setLocation(new Point(500, 200));
		setTitle("Locker Issuance");
		getContentPane().setBackground(new Color(0, 153, 102));
		getContentPane().setLayout(null);
		
		JLabel lblLockersInformation = new JLabel("Lockers Information");
		lblLockersInformation.setFont(new Font("Tahoma", Font.PLAIN, 15));
		lblLockersInformation.setBounds(142, 29, 139, 30);
		getContentPane().add(lblLockersInformation);
		
		JButton signOffButton = new JButton("Sign Off");
		signOffButton.addActionListener(new ActionListener() {
			public void actionPerformed(ActionEvent arg0) {
				logIn obj=new logIn();
				obj.setVisible(true);
				obj.setSize(600, 400);
				dispose();
			}
		});
		signOffButton.setBounds(10, 421, 89, 23);
		getContentPane().add(signOffButton);
		
		JButton backButton = new JButton("Back");
		backButton.addActionListener(new ActionListener() {
			public void actionPerformed(ActionEvent arg0) {
				lockerModule obj = new lockerModule();
				obj.setVisible(true);
				obj.setSize(600, 500);
				dispose();
			}
		});
		backButton.setBounds(466, 421, 89, 23);
		getContentPane().add(backButton);
		
		JComboBox identificationComboBox = new JComboBox();
		identificationComboBox.setModel(new DefaultComboBoxModel(new String[] {"Account Number"}));
		identificationComboBox.setSelectedIndex(-1);
		identificationComboBox.setMaximumRowCount(3);
		identificationComboBox.setToolTipText("");
		identificationComboBox.setBounds(91, 320, 153, 30);
		getContentPane().add(identificationComboBox);
		
		JLabel lblLockerSize = new JLabel("Identification Type");
		lblLockerSize.setBounds(93, 289, 94, 20);
		getContentPane().add(lblLockerSize);
		
		JLabel lblAccountNumber = new JLabel("Account Number");
		lblAccountNumber.setBounds(313, 289, 139, 21);
		getContentPane().add(lblAccountNumber);
		
		accountNumberText = new JTextField();
		
		accountNumberText.setBounds(313, 321, 153, 30);
		getContentPane().add(accountNumberText);
		accountNumberText.setColumns(10);
		
		
		
		JButton proceedButton = new JButton("Proceed");
		proceedButton.addActionListener(new ActionListener() {
			public void actionPerformed(ActionEvent arg0) {
				
				try{
					String accNum=accountNumberText.getText();
					Class.forName("COM.ibm.db2.jdbc.app.DB2Driver");
					java.sql.Connection connection = null;
					java.sql.Statement  lcl_stmt =null;
					connection = java.sql.DriverManager.getConnection("jdbc:db2:WA27389", "db2admin", "admin123/?");
								
					String query="select accountstatus.accountstatusid,accountstatus.accountstatus from accountnew,accountstatus where accountnew.accountstatusid=accountstatus.accountstatusid and accountnew.accountnum=?;";
					PreparedStatement statement = connection.prepareStatement(query);
					
					statement.setString(1, "1234567891245689");
					
					ResultSet result = statement.executeQuery();
					
					if (result.next()) {
					    String accountStatus = result.getString("accountstatus");
					    Integer id = result.getInt("accountstatusid");
					    if (id==1){
					    	
					    	 JOptionPane.showMessageDialog(null,"Authorized For Locker");
					    	 
					    	 getCustDetails("1234567891245689");
					    	 
					    	
					    }
					    else{
					    		
					     	 JOptionPane.showMessageDialog(null,"Not Authorized For Locker");
					    }
					   
					}
					else{
						 JOptionPane.showMessageDialog(null,"Account Not Found");
					}
				}
				catch(Exception e){
					System.out.println(e.getMessage());
				}
				
				
			}
		});
		proceedButton.setBounds(122, 421, 89, 23);
		getContentPane().add(proceedButton);
		
		
	}
	
	public void getCustDetails(String accNumText){
		
		try{
			String accNum="1234567891245689";
			Class.forName("COM.ibm.db2.jdbc.app.DB2Driver");
			java.sql.Connection connection = null;
			java.sql.Statement  lcl_stmt =null;
			connection = java.sql.DriverManager.getConnection("jdbc:db2:WA27389", "db2admin", "admin123/?");
						
			String query="select c.customername,c.email, c.contactno  from Accountnew a, customerAccountRelationship r, customer c where a.accountNum=r.accountNum and r.customerId=c.customerid and a.accountNum=?;";
			PreparedStatement statement = connection.prepareStatement(query);
			
			statement.setString(1, accNum);
			
			ResultSet result = statement.executeQuery();
			
			String queryAccount="select  a.accounttitle, a.branchCode, o.operatinginstruction from accountnew a,operatinginstruction o where a.operatinginstructionid=o.operatinginstructionid  and accountnum=?;";
			PreparedStatement statementAccount = connection.prepareStatement(queryAccount);
			
			statementAccount.setString(1, accNum);
			
			ResultSet resultAccount = statementAccount.executeQuery();
			
			HashMap<String, String> customerAccountRelationship = new HashMap<>();
			if(resultAccount.next()){
				customerAccountRelationship.put("accounttitle",resultAccount.getString("ACCOUNTTITLE")) ;
				int branchCode=resultAccount.getInt("BRANCHCODE");
				if(branchCode==1001){
					customerAccountRelationship.put("branchcode","No - Digital Account") ;
				}
				else{
					customerAccountRelationship.put("branchcode","Yes - "+ Integer.toString(resultAccount.getInt("BRANCHCODE"))) ;
				}
				customerAccountRelationship.put("operatinginstruction", resultAccount.getString("OPERATINGINSTRUCTION")) ;
				
			}
			
			
			
			if (result.next()) {
				customerAccountRelationship.put("customername",result.getString("CUSTOMERNAME")) ;
				customerAccountRelationship.put("contactno",result.getString("CONTACTNO")) ;
				customerAccountRelationship.put("email", result.getString("EMAIL")) ;
				
			    customerDetails obj= new customerDetails(0);
			    	obj.insertData(customerAccountRelationship);
			    	obj.insertLockers(availableLockers);
					obj.setVisible(true);
					obj.setSize(600,500);
					dispose();
			  
			   
			}
			else{
				 JOptionPane.showMessageDialog(null,"Customer Details Not Found");
			}
		}
		catch(Exception e){
			JOptionPane.showMessageDialog(null,"Could not connect to DB");
			System.out.println(e);
		}
		
		
		
	}
	 public static void main(String[] args) {
		 lockerIssuance frame = new lockerIssuance();
	    	frame.setSize(600, 500);
	    	frame.setVisible(true);
	    }
}
